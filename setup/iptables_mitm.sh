#!/bin/bash
#
# Device setup:
# 1. Get on the same wifi with IP ${TARGET}
# 2. Set the gateway to ${GATEWAY}
#
# Host setup:
# echo 1 > /proc/sys/net/ipv4/ip_forward
# Get wireguard up on wg0 (or replace OUTSIDE with eth0 below)
# Set up a transparent proxy on port 8081, with TLS and redirect traffic to the proper outside server

TARGET=192.168.10.50   # The device being tested
GATEWAY=192.168.10.40  # This is me.
INSIDE=wlan0
OUTSIDE=wg0

# Flush firewall
# Remove these if your iptables aren't normally clean
iptables -t nat -F PREROUTING
iptables -t nat -F POSTROUTING
iptables -F INPUT

# Take any traffic on port 443 and redirect it to our proxy
iptables -t nat -A PREROUTING -p tcp -s ${TARGET} --dport 443 -j DNAT --to-destination ${GATEWAY}:8081

# Set up "regular" NAT for all other traffic
iptables -t nat -A POSTROUTING -o ${OUTSIDE} -j MASQUERADE
iptables -A INPUT -i ${OUTSIDE} -m state --state RELATED,ESTABLISHED -j ACCEPT

# Add these if your FORWARD policy isn't already ACCEPT
#iptables -F FORWARD
#iptables -A FORWARD -i ${INSIDE} -j ACCEPT

