#!/bin/bash
#
# 1. Clone VM in vmware console
# 2. Generate new MAC address for new machine
# 3. Run this script as root

NETCONF=/etc/vmware/vmnet8/dhcpd/dhcpd.conf
VMROOT=/bulk/vm

# Hack to get root editing the dhcp config
# but also the user's ssh config
SSHCONF="${1:-${HOME}/.ssh/config}"
if [ ${UID} -ne 0 ]; then
  sudo ${0} ${SSHCONF}
  exit 0
fi

for MACHINE in ${VMROOT}/*/*.vmx; do
  MAC=$(egrep "ethernet0\.(generated)?[Aa]ddress " "${MACHINE}" | cut -d '"' -f 2)
  if [ -z "${MAC}" ]; then
    echo "Unable to find MAC address for machine ${MACHINE}. Skipping."
    continue
  fi

  # That machine already has a section, thanks
  grep -q -i "${MAC}" "${NETCONF}" && continue

  NAME=$(basename `dirname ${MACHINE}` | tr '[A-Z]' '[a-z]')
  echo "${MACHINE}: ${NAME} : ${MAC}"

  #cat >> /dev/stdout <<EOF
  cat >> ${NETCONF} <<EOF
host ${NAME} {
  hardware ethernet ${MAC};
  fixed-address 192.168.176.XX;
}

EOF

done

# 
vim -O "${SSHCONF}" /etc/vmware/vmnet8/dhcpd/dhcpd.conf

pkill vmnet-dhcpd
vmware-networks --start
